<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>微信商城 - 确认订单</title>
<link href="$!webPath/resources/style/weixin/default/css/phone.css" rel="stylesheet" type="text/css" />
<script src="$!webPath/resources/js/jquery-1.6.2.js"></script>
<script src="$!webPath/resources/js/jquery.validate.min.js"></script>
<script>
jQuery(document).ready(function(){	
 #if($!addrs.size()==0)
   jQuery.ajax({type:'POST',url:"$!webPath/weixin/cart_address.htm",async:false,data:{"store_id":"$!store_id"},success:function(html){
	   		jQuery("#order_infor").hide();
		    jQuery("#cart_address").after(html);
		    jQuery("#cart_address").show();  
	   }});   
  #end
  
  //
   jQuery(":radio[id=invoiceType]").click(function(){
     var val=jQuery(this).val();
	 if(val=="1"){
	   jQuery("#invoice_info").show();
	 }else{
	   jQuery("#invoice_info").hide();
	 }
  });
  //
   //
  jQuery(":radio[id^=addr_id]").click(function(){											   
       var addr_id=jQuery(this).val();
	   jQuery.ajax({type:'POST',url:'$!webPath/order_address.htm',data:{'addr_id':addr_id,"store_id":"$!sc.store.id"},dataType:'json',
				  beforeSend:function(){
					    jQuery("#order_save").attr("disabled",true);
					  }, 
				  success:function(data){
	                 jQuery("#ship_price").empty();
					 jQuery(data).each(function(index,item){
					     jQuery("#ship_price").append("<option value='"+item.value+"'>"+item.key+"</option>");
					 });
				     var ship_price=parseFloat(jQuery("#ship_price").val());
					 if(isNaN(ship_price)){
					    ship_price=0; 
					 }
	                 var coupon_amount=parseFloat(jQuery("#coupon_id").find("option:selected").attr("coupon_amount"));
					 if(isNaN(coupon_amount)){
					   coupon_amount=0;
					 }
	                 var goods_amount=parseFloat(jQuery("#goods_amount").val());
	                 var order_fee=goods_amount-coupon_amount+ship_price;
	                 jQuery("#order_store_amount").html("¥"+order_fee);
	                 jQuery("#order_pay_fee").html("¥"+order_fee); 
					 jQuery("#order_save").attr("disabled",false);
				  }
	   });
  });
  
  
   //
  jQuery("#coupon_id").change(function(){
      var coupon_amount=parseFloat(jQuery(this).find("option:selected").attr("coupon_amount"));
	  if(isNaN(coupon_amount)){
		 coupon_amount=0;
	  }
	  var goods_amount=parseFloat(jQuery("#goods_amount").val());
	  jQuery("#order_coupon_div").show();
	  var coupon_info="-¥"+coupon_amount;
	  jQuery("#order_coupon").html(coupon_info);
	  var ship_price=parseFloat(jQuery("#ship_price").val());
	  if(isNaN(ship_price)){
		  ship_price=0; 
	  }
	  var order_fee=goods_amount-coupon_amount+ship_price;
	  jQuery("#order_store_amount").html("¥"+order_fee);
	  jQuery("#order_pay_fee").html("¥"+order_fee);
	  if(coupon_amount==0){
	    jQuery("#order_coupon_div").hide();
	  }
  });
  //
  //
  jQuery("#ship_price").change(function(){
     var ship_price=parseFloat(jQuery(this).val());
	 if(isNaN(ship_price)){
		 ship_price=0; 
	 }
	 var coupon_amount=parseFloat(jQuery("#coupon_id").find("option:selected").attr("coupon_amount"));
	 if(isNaN(coupon_amount)){
		 coupon_amount=0;
	  }
	 var goods_amount=parseFloat(jQuery("#goods_amount").val());
	 var order_fee=goods_amount-coupon_amount+ship_price;
	 jQuery("#order_store_amount").html("¥"+order_fee);
	 jQuery("#order_pay_fee").html("¥"+order_fee); 
	 var text=jQuery(this).find("option:selected").text();
	 var transport=text.substring(0,text.indexOf("["));
	 jQuery("#transport").val(transport);
  });
});

function save_order(){
  jQuery("#cart_form").submit();
}
</script>
</head>
<body class="order_bg">
<div class="page_bottom">
<hgroup>
  <h3 class="goods_car"><a href="javascript:history.go(-1);"><em></em></a><span><b>确认订单</b></span></h3>
</hgroup>
<form action="$!webPath/weixin/goods_cart3.htm" method="post" enctype="$!webPath/weixin/goods_cart3.htm" id="cart_form">
  <input name="store_id" type="hidden" id="store_id" value="$!{sc.store.id}" />
  <div id="cart_address"> </div>
  <div id="order_infor">
    <div class="order_address">
      <h3><span>收货信息</span></h3>
      #set($addr_id="")
      #foreach($addr in $addrs)
      #if($!velocityCount==1)              #set($default_address_info="$!{addr.area.parent.parent.areaName}$!{addr.area.parent.areaName}$!{addr.area.areaName}$!{addr.area_info}")
      #set($addr_id="$!{addr.area.id}")
      #set($default_person_info="$!{addr.trueName} $!{addr.mobile}")
      #end
      <label>
      <strong class="add_check_input">
      <input type="radio" name="addr_id" id="addr_id" value="$!addr.id" #if($!velocityCount==1) checked="checked" #end/>
      </strong>
      <section class="order_address_box">
      <ul>
        <li> $!{addr.area.parent.parent.areaName}$!{addr.area.parent.areaName}$!{addr.area.areaName}</li>
        <li>$!{addr.area_info}</li>
        <li>收货人：$!{addr.trueName}</li>
        <li>电话：$!{addr.mobile}</li>
      </ul>
      </section>
      </label>
      #end </div>
    <div class="order_details">
      <h3 class="order_dth3"><span>订单详情</span></h3>
    
      <h4 class="order_dth4"><span>&nbsp;&nbsp;</span> <em>店铺：<b>$!{sc.store.store_name}</b></em></h4>
      #foreach($gc in $sc.gcs)
      <section class="order_dtlist">
        <dl>
          <dt> <img src="$!imageWebServer/$!gc.goods.goods_main_photo.path/$!{gc.goods.goods_main_photo.name}_small.$!{gc.goods.goods_main_photo.ext}" width="50" height="50"></dt>
          <dd>
            <h5>$!CommUtil.substring("$!{gc.goods.goods_name}",20)
              #if($!{gc.goods.group_buy}==2) <span style="color:#F00">(团购)</span> #end
              #if($!{gc.goods.bargain_status}==2) <span style="color:#F00">(特价)</span> #end
              #if($!{obj.goods.delivery_status}==2) <span style="color:#F00">[买就送]</span> #end </h5>
            #set($total_price=$!gc.count * $!gc.price) <span> #foreach($gsp in $obj.gsps)
            #if($!gsp.spec) <b>$!gsp.spec.name:<i>$!gsp.value</i></b> #end
            #end </span> <span><b>单价：<i>¥$!gc.price</i><i> X $!gc.count</i></b></span> <span><b>小计：<i>¥$!total_price</i></b></span> </dd>
        </dl>
      </section>
      #end
      #if($couponinfos.size()>0)
      <section class="choose_template">
        <h6>使用优惠券</h6>
        <div class="paysend" id="order_coupon_div" style="display:none;">优惠券抵消：<strong style="font-size:20px; color:#F00" id="order_coupon"></strong></div>
        <select name="coupon_id" id="coupon_id">
          <option value="" selected="selected" coupon_amount="0">请选择优惠券</option> 
    #foreach($info in $couponinfos)
          <option value="$!info.id" coupon_amount="$!info.coupon.coupon_amount"> $!CommUtil.substring("$!{info.coupon_sn}",20)
          [$!{info.coupon.coupon_name}]</option> 
    #end
        </select>
      </section>
      #end
      #if($!goods_delivery)
      <section class="choose_template">
        <h6>配送方式</h6>
        <ul>
          <li> <span style="margin-bottom:5px;">可用配送方式：</span>
            <select name="ship_price" style="width:110px;" id="ship_price">
            #set($ship_price=0)
            #foreach($sm in $transportTools.query_cart_trans($!sc,"$!addr_id"))
              #if($!velocityCount==1)
                #set($ship_price=$!sm.value)
              #end
              <option value="$!sm.value">$!sm.key</option>
            #end
            </select>
            <input name="transport" type="hidden" id="transport" value="平邮" />
          </li>
        </ul>
      </section>
      #end
      <section class="choose_template">
        <h6>发票信息</h6>
        <span class="template_select">
        <label>
          <input name="invoiceType" type="radio" id="invoiceType" value="0" checked="checked" />
          个人 </label>
        <label>
          <input name="invoiceType" id="invoiceType" type="radio" value="1" />
          单位 </label>
        </span> <span id="invoice_info" style="display:none;">
        <h6>发票抬头</h6>
        <span class="template_select">
        <textarea  name="invoice" id="invoice" cols="10" rows="" class="tem_textarea">
        </textarea>
        </span> </span>
        <h6>买家附言</h6>
        <textarea name="msg" id="msg" cols="10" rows="" class="tem_textarea" placeholder="请输入"></textarea>
      </section>
    </div>
    <div class="order_submit_box" style="bottom:0px">
      <ul>
          #set($order_total_price=$!CommUtil.null2Float($!{ship_price})+$!{sc.total_price})
        <li class="order_submit_txt">共计：<strong  id="order_pay_fee">¥$!{order_total_price}</strong></li>
        <li class="order_submit_btn">
          <button  name="order_save" type="button" onclick="save_order();"  style="cursor:pointer;" id="order_save"> 提交并支付 </button>
          <input name="cart_session" type="hidden" id="cart_session" value="$!cart_session" />
          <input name="goods_amount" type="hidden" id="goods_amount" value="$!{sc.total_price}" />
        </li>
      </ul>
    </div>
  </div>
</form>
</div>
</body>
</html>
